---
title: "Exploratory and Preprocessing Code"
output:
  word_document: default
  html_document: default
---

In this code: 
- Exploratory data review 
- Handling outliers and missing values
- Reduce 140 neighbourhoods into 10 regions 
- Create maps


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggmap)
library(dplyr)
library(ggplot2)
library(mapview)
library(textstem)
library(stringr)
library(Hmisc)
library(tidyverse)

register_google(key="AIzaSyBAfwGIFqbBu3Vfjz_nMO3iqmzYQZglyP8")
```


#Read data files 
```{r setup, include=FALSE}
mayreviews <- read.csv("/Users/Joanne/Documents/ChangSchool/Capstone/Airbnb/TOlistingfiles/Mayreviews.csv", na.strings="", stringsAsFactors = FALSE)
maylistings <- read.csv("/Users/Joanne/Documents/ChangSchool/Capstone/Airbnb/TOlistingfiles/maylistings_short.csv", na.strings="")
```

```{r}
str(maylistings)
str(mayreviews)

#rename list id to listing_id so both datasets key matches
names(maylistings)[1] <- "listing_id"
names(maylistings)
```

#Exploratory - listings dataset 
```{r}
#remove unneeded variables in maylistings - name, host_name, neighbourhood_group,  availability_365
#void variables we dont need

df <- subset(maylistings, select= -c(name, host_name, neighbourhood_group, availability_365))

#df has 12 variables 
#summary of variables using Hmisc library 
#describe(df) 

str(df)
```

How many missing values are there? 

```{r}
#check for NAs
colSums(is.na(df)|df == '')

#4205 last review & reviews_per_month missing values under comments
```

Let's take a look at some descriptive information 

```{r}
#quick descriptive information
with(df, summary(room_type))
with(df, summary(price))
with(df, summary(minimum_nights))
with(df, summary(number_of_reviews))
```

##Room Type 

```{r}
#LISTING GROUPED BY ROOM TYPE
df %>% 
  filter(!is.na(room_type)) %>% 
  group_by(room_type) %>%
  summarise(nr=length(room_type)) %>% 
  mutate(percentage = (nr/sum(nr)*100)) %>%
  ungroup() -> rt

rt

#Create bar graph - library(ggplot2)
ggplot(data= rt, aes(x = reorder(room_type, nr), y=nr/1000)) +
  geom_bar(stat="identity", fill="orange", colour="black") + theme_bw(base_size=10) + geom_text(aes(label=nr), vjust=0, nudge_y = 0.5) + 
  labs(title="Listings grouped by Room Type", x= "Room Type", y="Number of listings")
```

64% of listings are entire home/apt 
33% of listings are private rooms 
1.80% of listings are shared room 
0.33% are hotel rooms 

##Price 

```{r}
describe(df$price) #mean 144.6 
```
According to the descriptive summary above, variable price contains many outliers. 

Handling outliers: 
- Replaced outliers by capping at 0.5 quantile and 0.95 quantile 

```{r}
#boxplot of price 
outrt = boxplot.stats(df$price)$out #using IQR method to display data and outliers 
head(which(df$price %in% outrt)) #which numbers are outliers 
length(outrt) #total amount of outliers - 1625 (7% of total values) 

#handling extreme values that lie outside the 1.5* IQR limits with capping (replacing observations that lie below limit with value of 5th percentile and those that lie above the upper limit with the value of 95th percentile) 
replace_outliers <- function(x, removeNA=TRUE){ #function to capping outliers 
  price <- x
  qnt <- quantile(price, probs=c(.25, .75), na.rm= removeNA)
  caps <- quantile(price, probs=c(.05, .95), na.rm = removeNA)
  H <- 1.5 * IQR(price, na.rm = removeNA)
  price[price < (qnt[1] - H)] <- caps[1]
  price[price > (qnt[2] + H)] <- caps[2]
  price
}

df$capped_price <- replace_outliers(df$price) #capp price on df

#output comparison 
boxplot(df$price, main="Price with outliers")
boxplot(df$capped_price, main="price without outliers", boxwex=0.1)

describe(df$capped_price)
describe(df$price)
```


```{r}
#how mean price differs based on room type
RTmeans = with(df, by(capped_price, room_type, mean))
head(RTmeans)

#how mean price differs based on neighbourhood 
Nmeans = with(df, by(capped_price, neighbourhood, mean))
head(Nmeans)

library(ggpubr)
ggboxplot(df, x="room_type", y="capped_price") #boxplot by room type and price 
```


##minimum nights 
Explore minimum nights required by listing. 

```{r}
describe(df$minimum_nights)
boxplot(df$minimum_nights)
```

Realistically, those listings above 30 days minimum nights will rarely obtain any requests for stays because it becomes a long term rental.

```{r}
#boxplot of outliers of minimum nights 
outmn = boxplot.stats(df$minimum_nights)$out #using IQR method to display data 
head(which(df$minimum_nights %in% outmn)) #which numbers are outlier
length(outmn) #total amount of outliers - 3104 (14%)

#return outliers 2SD below and above the mean 
library(NCmisc)
length(which.outlier(df$minimum_nights, thr=2, method=c("sd"), high = TRUE, low=TRUE))
```

Handling outliers: 
Impute outliers with 2 standard deviation above the mean. Upper bound will become 70 days. Minimum number of days of 1 is a must, thus, no outliers in the lower bound will be imputed.

```{r}
mean(df$minimum_nights) + (sd(df$minimum_nights)*2) #70
length(which(df$minimum_nights >70)) #400 above upper bound

#Function to replace outliers with the capping of 2 SD lower and upper bound 
cap_outliers_mn <- function(x, removeNA=TRUE){ #function to capping outliers 
  minimum_nights <- x
  upper <- mean(minimum_nights) + (sd(minimum_nights)*2)
  minimum_nights[minimum_nights > upper] <- upper[1]
  minimum_nights
}

#capp outliers with 2sd upper bound
capped_minnights <- cap_outliers_mn(df$minimum_nights)
describe(capped_minnights)

#add into df capped minimum nights column 
df$capped_minnights <- as.integer(cap_outliers_mn(df$minimum_nights))
```

##number of reviews 
Explore number of reviews per listing as of May 2020

```{r}
describe(df$number_of_reviews)
boxplot(df$number_of_reviews)

df %>% filter(!is.na(room_type)) %>% #group by room type & count number of reviews 
  group_by(room_type) %>% 
  summarise(nr=length(number_of_reviews)) %>%
  ungroup() -> numr

numr

#boxplot by room type and number of reviews 
ggboxplot(df, x="room_type", y="number_of_reviews")
```
It makes sense that the amount of reviews for entire home/apt is the most as most of the listings are that type of room listing. 

##reviews per month 
```{r}
describe(df$reviews_per_month) #missing 4205 values 
boxplot(df$reviews_per_month)

#replace missing values with 0 
df$reviews_per_month[is.na(df$reviews_per_month)] <- 0

#boxplot by room type and reviews by month
ggboxplot(df, x="room_type", y="reviews_per_month")
```

##last review written date
```{r}
describe(df$last_review)
#missing 4205 
```

There are 4205 missing values for this variable. In the may review dataset, when we calculate unique values of listing_id. There is 17566- which is the amount left when the missing values are subtracted from the full listing. 

Reasons there might be missing value in this variable
- new listings thus no one has stayed there yet 
- have very limited stays but no reviews thus not relevant in this study 

Since we cannot replace the dates with 0's, its best to delete these rows. 

##Clean listings dataframe with imputed values and no missing values
```{r}
#remove row listings with last_review missing value 
dfclean <- na.omit(df, cols="last_review")

#remove original price and minimum nights 
dfclean <- subset(dfclean, select=-c(price, minimum_nights))

#change last_review to date structure
dfclean$last_review <- as.Date(dfclean$last_review, format = "%Y-%m-%d")

str(dfclean)
```


##neighbourhoods

First we explore the original dataset with 140 neighbourhoods. 

```{r}
#top 20 neighbourhoods 
dfclean %>% group_by(neighbourhood) %>%
  summarise(nr=length(neighbourhood)) %>% top_n(n=20) %>% 
  arrange(-nr) %>% ungroup() -> ng

#boxplot of top 20 neighbourhoods 
ggplot(data=ng, aes(x=reorder(neighbourhood,nr), y=nr)) +
  geom_bar(stat="identity", fill="grey", colour="black") + 
  coord_flip() + theme_bw(base_size=10) + 
  labs(title="Top 20 Toronto neighborhoods (by listings)", y="Number of Listings", x="Neighbourhood")

#top 5 neighbourhoods 
dfclean %>% group_by(neighbourhood) %>%
  summarise(nr=length(neighbourhood)) %>% top_n(n=5) %>% 
  arrange(-nr) %>% ungroup() -> tf

#boxplot of top 5 neighbourhoods 
ggplot(data=tf, aes(x=reorder(neighbourhood,nr), y=nr)) +
  geom_bar(stat="identity", fill="grey", colour="black") + 
  coord_flip() + theme_bw(base_size=10) + 
  labs(title="Top 5 Toronto neighborhoods (by listings)", y="Number of Listings", x="Neighbourhood")
```

Subset Top 5 neighbourhoods with the most listings

```{r}
#Top 5 neighborhoods by listing number 
dfclean %>% group_by(neighbourhood) %>%
  summarise(nr=length(neighbourhood)) %>% top_n(n=5) %>% 
  arrange(-nr) %>% ungroup() -> top5
top5 #output top 5 neighbourhood

#create new dataframe with top 5 neighbourhood
top5df <- subset(dfclean, neighbourhood == 'Waterfront Communities-The Island'|neighbourhood == 'Niagara'| neighbourhood =='Annex'| neighbourhood == 'Bay Street Corridor'| neighbourhood == 'Church-Yonge Corridor')

str(top5df)
```

There are 140 neighbourhoods in Toronto, since many machine learning algorithms do not allow for categories more than a certain number, and for ease of understanding, we may have to subset neighbourhoods into 10 regions. (torontoneighbourhoods.net & toronto.ca) 

Etobicoke 1-20
North York 21-53
East York 54-61
East End  62-70
Downtown 71-84
West End 85-93
Midtown 94-98, 101-102
Uptown 99, 100, 103,104,105
York-Crosstown 106-115
Scarborough 116-140

```{r}
length(levels(dfclean$neighbourhood))

#condense 140 neighbourhoods to 10 
dfclean$region <- fct_collapse(dfclean$neighbourhood, 
                               'Etobicoke' = c("West Humber-Clairville",
                                               "Mount Olive-Silverstone-Jamestown",
                                               "Thistletown-Beaumond Heights",
                                               "Rexdale-Kipling",
                                               "Elms-Old Rexdale",
                                               "Kingsview Village-The Westway",
                                               "Willowridge-Martingrove-Richview",
                                               "Humber Heights-Westmount",
                                               "Edenbridge-Humber Valley",
                                               "Princess-Rosethorn",
                                               "Eringate-Centennial-West Deane",
                                               "Markland Wood",
                                               "Etobicoke West Mall",
                                               "Islington-City Centre West",
                                               "Kingsway South",
                                               "Stonegate-Queensway",
                                               "Mimico (includes Humber Bay Shores)",
                                               "New Toronto",
                                               "Long Branch",
                                               "Alderwood"),
                               'North York' = c("Humber Summit",
                                                "Humbermede",
                                                "Pelmo Park-Humberlea",
                                                "Black Creek",
                                                "Glenfield-Jane Heights",
                                                "Downsview-Roding-CFB",
                                                "York University Heights",
                                                "Rustic",
                                                "Maple Leaf",
                                                "Brookhaven-Amesbury",
                                                "Yorkdale-Glen Park",
                                                "Englemount-Lawrence",
                                                "Clanton Park",
                                                "Bathurst Manor",
                                                "Westminster-Branson",
                                                "Newtonbrook West",
                                                "Willowdale West",
                                                "Lansing-Westgate",
                                                "Bedford Park-Nortown",
                                                "St.Andrew-Windfields",
                                                "Bridle Path-Sunnybrook-York Mills",
                                                "Banbury-Don Mills",
                                                "Victoria Village",
                                                "Flemingdon Park",
                                                "Parkwoods-Donalda",
                                                "Pleasant View",
                                                "Don Valley Village",
                                                "Hillcrest Village",
                                                "Bayview Woods-Steeles",
                                                "Newtonbrook East",
                                                "Willowdale East",
                                                "Bayview Village",
                                                "Henry Farm"),
                               'East York' = c("O'Connor-Parkview",
                                               "Thorncliffe Park",
                                               "Leaside-Bennington",
                                               "Broadview North",
                                               "Old East York",
                                               "Danforth East York",
                                               "Woodbine-Lumsden",
                                               "Taylor-Massey"),
                               'East End' = c("East End-Danforth",
                                              "The Beaches",
                                              "Woodbine Corridor",
                                              "Greenwood-Coxwell",
                                              "Danforth",
                                              "Playter Estates-Danforth",
                                              "North Riverdale",
                                              "Blake-Jones",
                                              "South Riverdale"),
                               'Downtown' = c("Cabbagetown-South St.James Town",
                                              "Regent Park",
                                              "Moss Park",
                                              "North St.James Town",
                                              "Church-Yonge Corridor",
                                              "Bay Street Corridor",
                                              "Waterfront Communities-The Island",
                                              "Kensington-Chinatown",
                                              "University",
                                              "Palmerston-Little Italy",
                                              "Trinity-Bellwoods",
                                              "Niagara",
                                              "Dufferin Grove",
                                              "Little Portugal"),
                               'West End' = c("South Parkdale",
                                              "Roncesvalles",
                                              "High Park-Swansea",
                                              "High Park North",
                                              "Runnymede-Bloor West Village",
                                              "Junction Area",
                                              "Weston-Pellam Park",
                                              "Corso Italia-Davenport",
                                              "Dovercourt-Wallace Emerson-Junction"),
                               'Midtown' = c("Wychwood",
                                             "Annex",
                                             "Casa Loma",
                                             "Yonge-St.Clair",
                                             "Rosedale-Moore Park",
                                             "Forest Hill South",
                                             "Forest Hill North"),
                               'Uptown' = c("Mount Pleasant East",
                                            "Yonge-Eglinton",
                                            "Lawrence Park South",
                                            "Mount Pleasant West",
                                            "Lawrence Park North"),
                               'York-Crosstown' = c("Humewood-Cedarvale",
                                                    "Oakwood Village",
                                                    "Briar Hill-Belgravia",
                                                    "Caledonia-Fairbank",
                                                    "Keelesdale-Eglinton West",
                                                    "Rockcliffe-Smythe",
                                                    "Beechborough-Greenbrook",
                                                    "Weston",
                                                    "Lambton Baby Point",
                                                    "Mount Dennis"), 
                               'Scarborough' = c("Steeles",
                                                 "L'Amoreaux",
                                                 "Tam O'Shanter-Sullivan",
                                                 "Wexford/Maryvale",
                                                 "Clairlea-Birchmount",
                                                 "Oakridge",
                                                 "Birchcliffe-Cliffside",
                                                 "Cliffcrest",
                                                 "Kennedy Park",
                                                 "Ionview",
                                                 "Dorset Park",
                                                 "Bendale",
                                                 "Agincourt South-Malvern West",
                                                 "Agincourt North",
                                                 "Milliken",
                                                 "Rouge",
                                                 "Malvern",
                                                 "Centennial Scarborough",
                                                 "Highland Creek",
                                                 "Morningside",
                                                 "West Hill",
                                                 "Woburn",
                                                 "Eglinton East",
                                                 "Scarborough Village",
                                                 "Guildwood")
)

levels(dfclean$region)
```

```{r}
#Explore plots with regions
#top 20 neighbourhoods 
dfclean %>% group_by(region) %>%
  summarise(nr=length(region)) %>% 
  arrange(-nr) %>% ungroup() -> r

#boxplot of top listings by region 
ggplot(data=r, aes(x=reorder(region,nr), y=nr)) +
  geom_bar(stat="identity", fill="grey", colour="black") + 
  coord_flip() + theme_bw(base_size=10) + 
  labs(title="Top listings by region", y="Number of Listings", x="Neighbourhood")


```

##Toronto MAP 
packages: get_map and ggmap 

```{r, echo=FALSE}
#fetch map with location name
#library(ggmap)

#registered google API and activated using register_google() 
#enabled geocoding API on google cloud 
#m <- get_map("Toronto",zoom=12, source="google") #get map of toronto
#ggmap(m)

#Fetch boundary specific map
bbox <- make_bbox(dfclean$longitude, dfclean$latitude, f=0.05)
b <- get_map(bbox, maptype = "toner-lite", source="stamen")
ggmap(b)

#Total TO listings by region 
ggmap(b) + geom_point(data=dfclean, aes(longitude, latitude, color=region), size=0.01, alpha = 0.7) + labs(x = "Longtitude", y= "Latitude", title="Airbnb Toronto Listing Locations (by region)")

#By region
bboxfive <- make_bbox(top5df$longitude, top5df$latitude, f=0.05) #boundary specific
bb <- get_map(bboxfive, maptype = "toner-lite", source="stamen")

ggmap(bb) + geom_point(data=top5df, aes(longitude, latitude, color=neighbourhood), size=0.01, alpha = 0.7) + labs(x = "Longtitude", y= "Latitude", title="Airbnb Toronto Top 5 Listing Locations")
```

```{r}
str(dfclean)

subsetregion <- subset(dfclean, select=c(listing_id, region))

#write.csv(dfclean, "dfclean.csv", row.names = FALSE, col.names = FALSE)
```

#Exploratory - review dataset 

```{r}
str(mayreviews)

#right outer join by listing_id
#mr <- right_join(maylistings, mayreviews)
``` 


```{r}
#convert date to an R date class 
mayreviews$date <- as.Date(mayreviews$date, format = "%Y-%m-%d")

#view R class of data 
class(mayreviews$date)

#view results 
head(mayreviews$date)

#new variable- extract YEAR (and convert to numeric format)
mayreviews$year <- as.numeric(format(mayreviews$date,'%Y'))

#new variable-extract MONTH (and convert to numeric format)
mayreviews$month <- as.numeric(format(mayreviews$date,'%m'))

str(mayreviews)
```

Group review by year written 
```{r}
mayreviews %>% filter(!is.na(year)) %>% group_by(year) %>%
  summarise(nr=length(year)) %>% arrange(-year) %>% ungroup() -> yr

yr

ggplot(data=yr, aes(x=year, y=nr)) +
  geom_line(stat="identity", colour="black", linetype=5, show.legend = TRUE) + 
  geom_point() + 
  geom_text(aes(label=nr), size=3, vjust=-0.5, nudge_y=0.5, colour='red') + 
  theme_bw(base_size=10) + 
  labs(title="Number of reviews (by Year)", y="Number of Listings") +
  scale_x_discrete(name = "Year", 
                   limits = c(seq(2009,2020,by=1)))
```


Break down monthly reviews written in 2019 
```{r, echo=FALSE}
mayreviews %>% filter(!is.na(year == '2019')) %>% group_by(month) %>%
  summarise(nr=length(month)) %>% ungroup() -> mth

mth

#create geom_line of monthly reviews written in 2019 
ggplot(data=mth, aes(x=month, y=nr)) + 
  geom_line(stat="identity", colour="black", linetype=5) + 
  geom_point() + 
  geom_text(aes(label=nr), vjust=-0.5, nudge_y=0.5, colour='red', size=3) + 
  theme_bw(base_size=10) + 
  labs(title="Number of reviews (by month in 2019) ", y="Number of Listings") + 
  scale_x_discrete(name = "Months", 
                   limits = c("1"="Jan", 
                              "2"="Feb", 
                              "3"= "Mar", 
                              "4"="April", 
                              "5"= "May", 
                              "6"="June", 
                              "7"= "july",
                              "8" = "Aug",
                              "9" = "Sept",
                              "10" = "Oct",
                              "11" = "Nov",
                              "12" = "Dec"
                              ))


#http://www.cookbook-r.com/Graphs/Axes_(ggplot2)/
#ensure x axis has every month for the label
```

##Time Series 

```{r, echo=FALSE}
#Grouping number of reviews by year and month 
m <- group_by(mayreviews, year, month)
monthly <- summarise(m, number_reviews=n())


ggplot(data=monthly, aes(x=month, y=number_reviews)) + 
  geom_bar(stat="identity", fill ="darkorchid4") + 
  facet_wrap( ~ year, ncol = 4) + 
  labs(title = "Number of Reviews posted in Toronto", 
       subtitle="By year", 
       y="Number of reviews", 
       x="Month") + 
  theme_bw(base_size = 10) +
  scale_x_discrete()
```

Clean dataset of mayreviews 
```{r}
str(mayreviews)
write.csv(mayreviews, "reviewsclean.csv")
```


